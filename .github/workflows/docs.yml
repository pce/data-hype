name: Documentation

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make dev.sh executable
        run: chmod +x ./dev.sh

      - name: Check Docker availability
        run: |
          echo "Checking docker availability..."
          docker --version || (echo "docker not available on runner" && exit 1)
          docker info || (echo "docker daemon not available" && exit 1)
          # Check for docker compose (v2 plugin) but allow docker-compose fallback
          if docker compose version >/dev/null 2>&1; then
            docker compose version
          else
            echo "docker compose plugin not found; checking docker-compose fallback"
            docker-compose --version || true
          fi

      - name: Build docs via dev.sh (Docker)
        env:
          CI: "true"
        run: |
          echo "Running: ./dev.sh docs"
          ./dev.sh docs

      - name: Verify docs-output
        run: |
          echo "Listing docs-output top-level:"
          ls -la docs-output || (echo "docs-output not found" && exit 1)
          echo "Checking for index.html"
          if [ -f docs-output/index.html ]; then
            echo "index.html present"
          else
            echo "Warning: index.html not found in docs-output"
          fi
          echo "Ensure .nojekyll exists (create if not)"
          if [ ! -f docs-output/.nojekyll ]; then
            touch docs-output/.nojekyll
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs-output

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Show Pages URL
        if: always()
        run: |
          echo "Pages URL: ${{ steps.deployment.outputs.page_url }}"
          printf "Open the site: %s\n" "${{ steps.deployment.outputs.page_url }}"
