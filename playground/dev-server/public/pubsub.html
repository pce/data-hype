<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pub/Sub — Hype Playground</title>
  <meta name="description" content="Pub/Sub example using Hype pubsub plugin with a DOM CustomEvent bridge so the page works without the runtime." />
  <script src="https://cdn.tailwindcss.com" defer></script>
  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --accent: #0366d6;
      --radius: 10px;
      --gap: 12px;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:var(--bg);
      color:#0f172a;
    }
    .container { max-width: 980px; margin: 28px auto; padding: 18px; }
    .card { background: var(--card); border-radius: var(--radius); padding: 18px; box-shadow: 0 1px 2px rgba(2,6,23,0.06); margin-bottom: 12px; }
    .muted { color: var(--muted); }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; font-size:0.95rem; }
    .topic { padding:8px 12px; border-radius:8px; border:1px solid #eef2ff; background:#fff; display:inline-flex; gap:8px; align-items:center; }
    .list { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    .subscriber { flex: 1 1 300px; border-radius:8px; padding:12px; background:#fcfdff; border:1px solid #eef2f8; min-width:220px; }
    .entry { padding:8px 10px; border-radius:6px; margin-top:8px; background:#fff; border:1px solid #f1f5f9; }
    .small { font-size:0.9rem; }
    .badge { display:inline-block; padding:6px 10px; border-radius:8px; background: rgba(3,102,214,0.06); color:var(--accent); font-weight:600; text-decoration:none; }
    .btn { padding:6px 10px; border-radius:8px; border:0; cursor:pointer; }
    .btn-ghost { background:#fff; border:1px solid #e6eef6; color:#0f172a; }
    .btn-primary { background:var(--accent); color:#fff; }
    .muted-note { color:var(--muted); font-size:0.9rem; margin-top:8px; }
    @media (max-width:720px){ .controls{ gap:6px } .list{ flex-direction:column } }
  </style>
</head>
<body>
  <main class="container" role="main" aria-labelledby="</body>page-title">
    <header class="card" role="banner" aria-label="Pub/Sub demo header">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h1 id="page-title" style="margin:0;font-size:1.25rem">Pub/Sub Demo</h1>
          <p class="muted small" style="margin-top:6px;">
            Demonstrates</div> the Hype pubsub plugin (if loaded) and a DOM CustomEvent bridge so the page works without the runtime.
            The bridge listens for <code class="mono">hype:pub</code> CustomEvents of shape <code class="mono">{ detail: { topic, payload } }</code>.
          </p>
        </div>

        <div class="controls" aria-hidden="false">
          <a class="badge" href="/live.html" aria-label="Live ticker example">Live ticker</a>
          <a class="badge" href="/sse.html" style="margin-left:6px;" aria-label="SSE example">SSE</a>
        </div>
      </div>
    </header>

    <section class="card" aria-labelledby="pubcontrols">
      <h2 id="pubcontrols" style="margin:0 0 8px 0">Publishers</h2>
      <p class="muted small" style="margin:0 0 10px 0">Two ways to publish events on this page:</p>

      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
        <!-- Markup-first publish (no-op without Hype) -->
        <div class="topic" title="Markup-first Hype publish (no-op if Hype not present)">
          <strong class="mono">Markup publish</strong>
          <div style="display:flex;gap:8px;margin-left:8px">
            <button
              type="button"
              data-hype-on-click='["pub","news", {"text":"Breaking: markup publish"}]'
              class="mono small btn btn-ghost"
              aria-label="Publish news via Hype"
            >News (via Hype)</button>

            <button
              type="button"
              data-hype-on-click='["pub","price", {"symbol":"AAPL","price":null}]'
              class="mono small btn btn-ghost"
              aria-label="Publish price via Hype"
            >Price (via Hype)</button>
          </div>
        </div>

        <!-- DOM publish always works -->
        <div class="topic" style="margin-left:8px" aria-hidden="false">
          <strong class="mono">DOM publish</strong>
          <div style="display:flex;gap:8px;margin-left:8px">
            <button id="domNews" type="button" class="mono small btn btn-primary" aria-label="Publish news (DOM)">Publish News (DOM)</button>
            <button id="domPrice" type="button" class="mono small btn btn-primary" aria-label="Publish price (DOM)">Publish Price (DOM)</button>
          </div>
        </div>

        <!-- Custom publish -->
        <div style="display:flex;gap:8px;align-items:center;margin-left:8px;flex:1 1 420px">
          <input id="customTopic" class="mono" placeholder="topic e.g. chat" style="padding:8px;border-radius:8px;border:1px solid #e6eef6;flex:0 0 140px" aria-label="Custom topic" />
          <input id="customPayload" class="mono" placeholder='payload JSON e.g. {"msg":"hi"}' style="padding:8px;border-radius:8px;border:1px solid #e6eef6;width:100%;flex:1 1 320px" aria-label="Custom payload JSON" />
          <button id="customPublish" type="button" class="mono small btn btn-primary" aria-label="Publish custom event">Publish</button>
        </div>
      </div>

      <p class="muted-note">Markup-first examples show how Hype keeps behavior declarative. Use the DOM buttons to publish immediately without Hype present.</p>
    </section>

    <section class="card" aria-labelledby="subscribers">
      <h2 id="subscribers" style="margin:0 0 8px 0">Subscribers</h2>

      <div class="list" role="region" aria-live="polite" aria-atomic="false">
        <div class="subscriber" id="newsSub" aria-label="News subscriber">
          <h3 style="margin:0">News</h3>
          <div id="newsList" class="small" style="margin-top:8px"></div>
          <div style="margin-top:10px"><button id="newsClear" type="button" class="small btn btn-ghost" aria-label="Clear news">Clear</button></div>
        </div>

        <div class="subscriber" id="priceSub" aria-label="Price subscriber">
          <h3 style="margin:0">Prices</h3>
          <div id="priceList" class="small" style="margin-top:8px"></div>
          <div style="margin-top:10px"><button id="priceClear" type="button" class="small btn btn-ghost" aria-label="Clear prices">Clear</button></div>
        </div>

        <div class="subscriber" id="rawSub" aria-label="Raw events">
          <h3 style="margin:0">All events (DOM)</h3>
          <div id="rawList" class="small" style="margin-top:8px"></div>
          <div style="margin-top:10px"><button id="rawClear" type="button" class="small btn btn-ghost" aria-label="Clear raw events">Clear</button></div>
        </div>
      </div>

      <p class="muted small" style="margin-top:10px">This area shows updates from both Hype's pub/sub (if loaded) and DOM-dispatched events. The recommended event shape is <code class="mono">new CustomEvent('hype:pub', { detail: { topic, payload } })</code>.</p>
    </section>

    <footer class="card muted small" style="display:block">
      <strong>Developer:</strong> this demo will optionally import a runtime from <code class="mono">/static/js/hype</strong>.js</code> (non-blocking) and attempt to subscribe if the runtime exposes a pub/sub API.
    </footer>
  </main>

  <script type="module">
    // Non-blocking dynamic import helper for optional Hype runtime
    async function tryAttachHype() {
      try {
        const mod = await import('/static/js/hype.js').catch(() => null);
        const hype = mod && (mod.hype || mod.default || mod) || null;
        if (hype && typeof hype.init === 'function') {
          try { hype.init(); } catch (e) { console.warn('hype.init() error', e); }
        }
        return hype;
      } catch (err) {
        console.debug('Hype import failed (dev):', err);
        return null;
      }
    }

    (function () {
      const newsList = document.getElementById('newsList');
      const priceList = document.getElementById('priceList');
      const rawList = document.getElementById('rawList');

      const domNews = document.getElementById('domNews');
      const domPrice = document.getElementById('domPrice');
      const customTopic = document.getElementById('customTopic');
      const customPayload = document.getElementById('customPayload');
      const customPublish = document.getElementById('customPublish');

      const newsClear = document.getElementById('newsClear');
      const priceClear = document.getElementById('priceClear');
      const rawClear = document.getElementById('rawClear');

      function addEntry(container, text) {
        if (!container) return;
        const div = document.createElement('div');
        div.className = 'entry';
        div.textContent = `${new Date().toLocaleTimeString()} — ${text}`;
        container.insertBefore(div, container.firstChild);
      }

      // Handler for CustomEvent produced by Hype pubsub plugin:
      // new CustomEvent("hype:pub", { detail: { topic, payload } })
      function handleHypePubEvent(ev) {
        try {
          const d = ev && ev.detail;
          if (!d || !d.topic) return;
          const topic = String(d.topic);
          const payload = d.payload;
          addEntry(rawList, `${topic} — ${JSON.stringify(payload)}`);

          if (topic === 'news') {
            const text = (payload && payload.text) ? payload.text : JSON.stringify(payload);
            addEntry(newsList, text);
          } else if (topic === 'price') {
            const sym = (payload && payload.symbol) ? payload.symbol : 'UNKNOWN';
            const price = (payload && (payload.price != null)) ? payload.price : JSON.stringify(payload);
            addEntry(priceList, `${sym}: ${price}`);
          }
        } catch (e) {
          console.warn('handleHypePubEvent error', e);
        }
      }

      // Listen for DOM bridge events (works without Hype)
      document.addEventListener('hype:pub', handleHypePubEvent);

      // DOM publish buttons - dispatch the same shape Hype uses
      if (domNews) {
        domNews.addEventListener('click', () => {
          const payload = { text: 'DOM: Breaking update at ' + new Date().toLocaleTimeString() };
          const ev = new CustomEvent('hype:pub', { detail: { topic: 'news', payload }, bubbles: true, composed: true });
          document.dispatchEvent(ev);
        });
      }

      if (domPrice) {
        domPrice.addEventListener('click', () => {
          const price = Math.round((100 + Math.random() * 30) * 100) / 100;
          const payload = { symbol: 'AAPL', price };
          const ev = new CustomEvent('hype:pub', { detail: { topic: 'price', payload }, bubbles: true, composed: true });
          document.dispatchEvent(ev);
        });
      }

      if (customPublish) {
        customPublish.addEventListener('click', () => {
          const topic = (customTopic.value || '').trim();
          if (!topic) return alert('Please enter a topic');
          let payload = customPayload.value || '';
          try {
            payload = payload ? JSON.parse(payload) : null;
          } catch (e) {
            payload = customPayload.value;
          }
          const ev = new CustomEvent('hype:pub', { detail: { topic, payload }, bubbles: true, composed: true });
          document.dispatchEvent(ev);
          customTopic.value = '';
          customPayload.value = '';
        });
      }

      // Clear buttons
      if (newsClear) newsClear.addEventListener('click', () => { if (newsList) newsList.innerHTML = ''; });
      if (priceClear) priceClear.addEventListener('click', () => { if (priceList) priceList.innerHTML = ''; });
      if (rawClear) rawClear.addEventListener('click', () => { if (rawList) rawList.innerHTML = ''; });

      // If a Hype runtime exists, attempt to attach using its pub/sub API
      (async function attachHypeIfPresent() {
        const hypeInstance = await tryAttachHype();
        if (!hypeInstance) {
          addEntry(rawList, 'No Hype runtime detected — using DOM bridge.');
          return;
        }

        try {
          // If runtime exposes both sub and pub, wire them so markup-driven pub works.
          if (typeof hypeInstance.sub === 'function' && typeof hypeInstance.pub === 'function') {
            hypeInstance.sub('news', (payload) => {
              const text = (payload && payload.text) ? payload.text : JSON.stringify(payload);
              addEntry(newsList, `(hype.sub) ${text}`);
            });
            hypeInstance.sub('price', (payload) => {
              const sym = (payload && payload.symbol) ? payload.symbol : 'UNKNOWN';
              const price = (payload && (payload.price != null)) ? payload.price : JSON.stringify(payload);
              addEntry(priceList, `(hype.sub) ${sym}: ${price}`);
            });

            addEntry(rawList, 'Hype runtime detected — subscribed via hype.sub()');

            // Expose pub for debugging in dev if available
            if (typeof hypeInstance.pub === 'function') {
              try { window.__hypePub = hypeInstance.pub; } catch (_) {}
            }
          } else {
            // Otherwise rely on DOM events (we already listen to those).
            addEntry(rawList, 'Hype runtime loaded but pub/sub API not detected — using DOM bridge.');
          }
        } catch (err) {
          console.warn('Failed to attach to hype pubsub API', err);
          addEntry(rawList, 'Failed to attach Hype pub/sub: ' + String(err));
        }
      })();

      // Dev helpers
      try {
        window.__hypePubsubDemo = {
          publish: (topic, payload) => document.dispatchEvent(new CustomEvent('hype:pub', { detail: { topic, payload } })),
          subscribeDom: () => document.addEventListener('hype:pub', handleHypePubEvent)
        };
      } catch (_) {}

    })();
  </script>
</body>
</html>
