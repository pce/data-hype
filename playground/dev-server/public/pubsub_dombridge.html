<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>— Hype Playground</title>
  <meta name="description" content="Pub/Sub example using Hype pubsub plugin with a DOM CustomEvent bridge so the page works without the runtime." />
  <link rel="stylesheet" href="/tailwind.css" />
</head>
<body class="min-h-screen bg-gradient-to-b from-teal-800 to-gray-400 p-8 text-slate-900">
  <div class="max-w-4xl mx-auto">
    <header class="mb-8 text-white">
      <h1 class="text-4xl md:text-5xl font-thin tracking-tight">
        Hype Pub/Sub
        <span class="block mt-2 text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-rose-400 text-base">markup-first · </span>
      </h1>
      <p class="mt-3 text-sm text-teal-200">
        Behavior is declared via <code class="font-mono text-xs bg-white/10 px-1 rounded">data-hype-*</code> attributes.
        This demo demonstrates runtime network behavior and an always-available DOM bridge.
      </p>
    </header>

    <!-- Publishers -->
    <section aria-labelledby="pubcontrols" class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 id="pubcontrols" class="text-lg font-semibold mb-2">Publishers</h2>
      <p class="text-sm text-gray-500 mb-4">Two ways to publish events on this page: markup-driven (requires Hype) or DOM bridge (always works).</p>

      <div class="flex flex-wrap gap-4 items-start">
        <!-- Markup-first publish -->
        <div class="inline-flex items-center gap-4 p-3 rounded-lg border bg-white/60">
          <div class="font-mono text-sm font-medium">Markup publish</div>
          <div class="flex gap-2">
            <button
              type="button"
              data-hype-on-click='["pub","news", {"text":"Breaking: markup publish"}]'
              class="text-sm font-mono px-3 py-1 border rounded-md hover:bg-gray-50"
              aria-label="Publish news via Hype"
            >News (via Hype)</button>

            <button
              type="button"
              data-hype-on-click='["pub","price", {"symbol":"AAPL","price":null}]'
              class="text-sm font-mono px-3 py-1 border rounded-md hover:bg-gray-50"
              aria-label="Publish price via Hype"
            >Price (via Hype)</button>
          </div>
        </div>

        <!-- DOM publish always works -->
        <div class="inline-flex items-center gap-4 p-3 rounded-lg border bg-white/60">
          <div class="font-mono text-sm font-medium">DOM publish</div>
          <div class="flex gap-2">
            <button id="domNews" type="button" class="text-sm px-3 py-1 rounded-md bg-blue-600 text-white hover:bg-blue-700" aria-label="Publish news (DOM)">Publish News (DOM)</button>
            <button id="domPrice" type="button" class="text-sm px-3 py-1 rounded-md bg-blue-600 text-white hover:bg-blue-700" aria-label="Publish price (DOM)">Publish Price (DOM)</button>
          </div>
        </div>

        <!-- Custom publish -->
        <div class="flex-1 min-w-[260px] flex items-center gap-2 p-3 rounded-lg border bg-white/60">
          <input id="customTopic" class="font-mono text-sm px-3 py-1 border rounded-md w-36" placeholder="topic e.g. chat" aria-label="Custom topic" />
          <input id="customPayload" class="font-mono text-sm px-3 py-1 border rounded-md flex-1" placeholder='payload JSON e.g. {"msg":"hi"}' aria-label="Custom payload JSON" />
          <button id="customPublish" type="button" class="text-sm px-3 py-1 rounded-md bg-blue-600 text-white hover:bg-blue-700">Publish</button>
        </div>
      </div>

      <p class="mt-3 text-xs text-gray-500">Markup-first buttons become active when the runtime is present. The DOM bridge dispatches <code class="font-mono text-xs">new CustomEvent('hype:pub', { detail: { topic, payload } })</code>.</p>
    </section>

    <!-- Subscribers -->
    <section aria-labelledby="subscribers" class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 id="subscribers" class="text-lg font-semibold mb-2">Subscribers</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4" role="region" aria-live="polite" aria-atomic="false">
        <div id="newsSub" class="p-4 rounded-lg bg-white border min-h-[120px]">
          <h3 class="text-sm font-semibold mb-2">News</h3>
          <div id="newsList" class="text-sm space-y-2"></div>
          <div class="mt-3"><button id="newsClear" class="text-sm px-3 py-1 rounded-md border hover:bg-gray-50">Clear</button></div>
        </div>

        <div id="priceSub" class="p-4 rounded-lg bg-white border min-h-[120px]">
          <h3 class="text-sm font-semibold mb-2">Prices</h3>
          <div id="priceList" class="text-sm space-y-2"></div>
          <div class="mt-3"><button id="priceClear" class="text-sm px-3 py-1 rounded-md border hover:bg-gray-50">Clear</button></div>
        </div>

        <div id="rawSub" class="p-4 rounded-lg bg-white border min-h-[120px]">
          <h3 class="text-sm font-semibold mb-2">All events (DOM)</h3>
          <div id="rawList" class="text-sm space-y-2"></div>
          <div class="mt-3"><button id="rawClear" class="text-sm px-3 py-1 rounded-md border hover:bg-gray-50">Clear</button></div>
        </div>
      </div>

      <p class="mt-3 text-xs text-gray-500">This area shows updates from both Hype's pub/sub (if loaded) and DOM-dispatched events.</p>
    </section>

    <footer class="bg-white rounded-lg shadow p-4 text-sm text-gray-700">
      <strong class="block">Developer:</strong>
      <div class="mt-1">
        This demo will auto-import <code class="font-mono text-xs">/static/js/hype.js</code> so markup-driven pub/sub examples work. If the runtime is not available the demo falls back to the DOM bridge.
      </div>
    </footer>
  </div>

  <script type="module">
    // Minimal auto-import so this demo demonstrates runtime network behavior.
    // Keep logic minimal: import, init (if present), then attach to pub/sub API when available.
    let __hypeInstance = null;
    try {
      const m = await import('/static/js/hype.js').catch(() => null);
      __hypeInstance = m ? ((typeof m.createHype === 'function') ? m.createHype() : (m.default ?? m)) : null;
      if (__hypeInstance && typeof __hypeInstance.init === 'function') {
        try { __hypeInstance.init(); } catch (e) { console.warn('hype.init() error', e); }
      }
    } catch (e) {
      console.warn('Auto-import failed', e);
    }

    (function () {
      const newsList = document.getElementById('newsList');
      const priceList = document.getElementById('priceList');
      const rawList = document.getElementById('rawList');

      const domNews = document.getElementById('domNews');
      const domPrice = document.getElementById('domPrice');
      const customTopic = document.getElementById('customTopic');
      const customPayload = document.getElementById('customPayload');
      const customPublish = document.getElementById('customPublish');

      const newsClear = document.getElementById('newsClear');
      const priceClear = document.getElementById('priceClear');
      const rawClear = document.getElementById('rawClear');

      function addEntry(container, text) {
        if (!container) return;
        const div = document.createElement('div');
        div.className = 'rounded border bg-white p-2 text-sm';
        div.textContent = `${new Date().toLocaleTimeString()} — ${text}`;
        container.insertBefore(div, container.firstChild);
      }

      // Handler for CustomEvent produced by Hype pubsub plugin:
      // new CustomEvent("hype:pub", { detail: { topic, payload } })
      function handleHypePubEvent(ev) {
        try {
          const d = ev && ev.detail;
          if (!d || !d.topic) return;
          const topic = String(d.topic);
          const payload = d.payload;
          addEntry(rawList, `${topic} — ${JSON.stringify(payload)}`);

          if (topic === 'news') {
            const text = (payload && payload.text) ? payload.text : JSON.stringify(payload);
            addEntry(newsList, text);
          } else if (topic === 'price') {
            const sym = (payload && payload.symbol) ? payload.symbol : 'UNKNOWN';
            const price = (payload && (payload.price != null)) ? payload.price : JSON.stringify(payload);
            addEntry(priceList, `${sym}: ${price}`);
          }
        } catch (e) {
          console.warn('handleHypePubEvent error', e);
        }
      }

      // Listen for DOM bridge events (works without Hype)
      document.addEventListener('hype:pub', handleHypePubEvent);

      // DOM publish buttons - dispatch the same shape Hype uses
      if (domNews) {
        domNews.addEventListener('click', () => {
          const payload = { text: 'DOM: Breaking update at ' + new Date().toLocaleTimeString() };
          const ev = new CustomEvent('hype:pub', { detail: { topic: 'news', payload }, bubbles: true, composed: true });
          document.dispatchEvent(ev);
        });
      }

      if (domPrice) {
        domPrice.addEventListener('click', () => {
          const price = Math.round((100 + Math.random() * 30) * 100) / 100;
          const payload = { symbol: 'AAPL', price };
          const ev = new CustomEvent('hype:pub', { detail: { topic: 'price', payload }, bubbles: true, composed: true });
          document.dispatchEvent(ev);
        });
      }

      if (customPublish) {
        customPublish.addEventListener('click', () => {
          const topic = (customTopic.value || '').trim();
          if (!topic) return alert('Please enter a topic');
          let payload = customPayload.value || '';
          try {
            payload = payload ? JSON.parse(payload) : null;
          } catch (e) {
            payload = customPayload.value;
          }
          const ev = new CustomEvent('hype:pub', { detail: { topic, payload }, bubbles: true, composed: true });
          document.dispatchEvent(ev);
          customTopic.value = '';
          customPayload.value = '';
        });
      }

      // Clear buttons
      if (newsClear) newsClear.addEventListener('click', () => { if (newsList) newsList.innerHTML = ''; });
      if (priceClear) priceClear.addEventListener('click', () => { if (priceList) priceList.innerHTML = ''; });
      if (rawClear) rawClear.addEventListener('click', () => { if (rawList) rawList.innerHTML = ''; });

      // Helper to attach a Hype runtime instance (call this if you create the instance elsewhere)
      function attachHypeInstance(hypeInstance) {
        if (!hypeInstance) return;
        try {
          if (typeof hypeInstance.sub === 'function') {
            try {
              hypeInstance.sub('news', (payload) => {
                const text = (payload && payload.text) ? payload.text : JSON.stringify(payload);
                addEntry(newsList, `(hype.sub) ${text}`);
              });
              hypeInstance.sub('price', (payload) => {
                const sym = (payload && payload.symbol) ? payload.symbol : 'UNKNOWN';
                const price = (payload && (payload.price != null)) ? payload.price : JSON.stringify(payload);
                addEntry(priceList, `(hype.sub) ${sym}: ${price}`);
              });
              addEntry(rawList, 'Hype runtime attached — subscribed via hype.sub()');
            } catch (e) {
              addEntry(rawList, 'Hype runtime attached but subscription failed: ' + String(e));
            }
          } else {
            addEntry(rawList, 'Hype runtime attached but pub/sub API not detected — using DOM bridge.');
          }
          if (typeof hypeInstance.pub === 'function') {
            try { window.__hypePub = hypeInstance.pub; } catch (_) {}
          }
        } catch (err) {
          console.warn('Failed to attach to hype pubsub API', err);
          addEntry(rawList, 'Failed to attach Hype pub/sub: ' + String(err));
        }
      }

      // Dev helpers exported to window so the demo host can opt-in or inspect
      try {
        window.__hypePubsubDemo = {
          publish: (topic, payload) => document.dispatchEvent(new CustomEvent('hype:pub', { detail: { topic, payload } })),
          attachHypeInstance,
          importAndAttach: async function () {
            try {
              const m = await import('/static/js/hype.js'); // manual opt-in
              const hype = (typeof m.createHype === 'function') ? m.createHype() : (m.default ?? m);
              if (hype && typeof hype.init === 'function') {
                try { hype.init(); } catch (e) { console.warn('hype.init() error', e); }
              }
              attachHypeInstance(hype);
            } catch (e) {
              console.warn('importAndAttach failed', e);
              addEntry(rawList, 'Runtime import failed: ' + String(e));
            }
          },
          subscribeDom: () => document.addEventListener('hype:pub', handleHypePubEvent)
        };
      } catch (_) {}

      // If the auto-import succeeded, attach that instance so markup-driven pub works immediately
      if (__hypeInstance) attachHypeInstance(__hypeInstance);

      // Notify developer which path was used
      if (__hypeInstance) {
        addEntry(rawList, 'Hype runtime auto-imported and initialized for this demo. Markup-driven publish buttons are active.');
      } else {
        addEntry(rawList, 'Hype runtime auto-import attempted but not available — using DOM bridge.');
      }
    })();
  </script>
</body>
</html>
